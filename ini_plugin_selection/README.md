# Plugin via Ini Configuration Experiment
This experiment is meant to illustrate the ability to select which plugins to utilize in the pytest
session according to the built in `-p` command line argument. As a convenience this selection can
be captured in `ini` files, one file per configuration.

## Directory Structure
A single test module in the tests folder, all of the plugin files in the plugins folder, and
finally all of the ini files in the config folder.

```shell
ini_plugin_selection/
├── README.md
├── config
│   ├── config_x.ini
│   ├── config_xy.ini
│   └── config_y.ini
├── plugins
│   ├── plugin_x.py
│   ├── plugin_y.py
│   └── plugin_z.py
└── tests
    └── test_module.py
```

## Relevant Command Line Options
Here is a collection of excerpts from the pytest help message distilled down to each of the relevant
pieces which will be applied in this exercise.

```shell
usage: pytest [options] [file_or_dir] [file_or_dir] [...]

general:
  -c file               load configuration from `file` instead of trying to
                        locate one of the implicit configuration files.

test session debugging and configuration:
  -p name               early-load given plugin module name or entry point
                        (multi-allowed). To avoid loading of plugins, use the
                        `no:` prefix, e.g. `no:doctest`.

[pytest] ini-options in the first pytest.ini|tox.ini|setup.cfg file found:

  addopts (args):       extra command line options
```

https://docs.pytest.org/en/2.7.3/customize.html#confval-addopts



## Overview

This experiment demonstrates conclusively that plugins can in fact be selected from the command line
and that they follow some of the same precedence rules you'd expect like controlling the plugin order
of the `pytest_plugins` global, which is to say the last definition seen overrides all that came before.


# Test Results
The following is the console output generated by running pytest over the test folder, using the
`python -m pytest` style to put the experiment directory on the python path.

**Config X**
<details>
<summary>Click to expand!</summary>
<pre>
$ python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_x.ini
================================================= test session starts ==================================================
platform darwin -- Python 3.7.3, pytest-5.0.1, py-1.8.0, pluggy-0.12.0 -- /Users/USERX/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/USERX/pytest_behavior/ini_plugin_selection, inifile: ini_plugin_selection/config/config_x.ini
plugins: openfiles-0.3.2, arraydiff-0.3, doctestplus-0.3.0, cases-2.2.5, remotedata-0.3.1
collected 6 items

ini_plugin_selection/tests/test_module.py::test_control PASSED                                                   [ 16%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_x PASSED                                               [ 33%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_x PASSED                                               [ 50%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_y FAILED                                               [ 66%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_y FAILED                                               [ 83%]
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED                                               [100%]

======================================================= FAILURES =======================================================
___________________________________________________ test_fixture_1_y ___________________________________________________

fixture_1 = 'x1'

    def test_fixture_1_y(fixture_1):
>       assert fixture_1 == "y1"
E       AssertionError: assert 'x1' == 'y1'
E         - x1
E         + y1

ini_plugin_selection/tests/test_module.py:17: AssertionError
___________________________________________________ test_fixture_2_y ___________________________________________________

fixture_2 = 'x2'

    def test_fixture_2_y(fixture_2):
>       assert fixture_2 == "y2"
E       AssertionError: assert 'x2' == 'y2'
E         - x2
E         + y2

ini_plugin_selection/tests/test_module.py:20: AssertionError
========================================== 2 failed, 4 passed in 0.08 seconds ==========================================
</pre>
</details>
<br>

**Config Y**
<details>
<summary>Click to expand!</summary>
<pre>
$ python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_y.ini
=============================================== test session starts ===============================================
platform darwin -- Python 3.7.3, pytest-5.0.1, py-1.8.0, pluggy-0.12.0 -- /Users/USERX/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/USERX/pytest_behavior/ini_plugin_selection, inifile: ini_plugin_selection/config/config_y.ini
plugins: openfiles-0.3.2, arraydiff-0.3, doctestplus-0.3.0, cases-2.2.5, remotedata-0.3.1
collected 6 items

ini_plugin_selection/tests/test_module.py::test_control PASSED                                              [ 16%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_x FAILED                                          [ 33%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_x FAILED                                          [ 50%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_y PASSED                                          [ 66%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_y PASSED                                          [ 83%]
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED                                          [100%]

==================================================== FAILURES =====================================================
________________________________________________ test_fixture_1_x _________________________________________________

fixture_1 = 'y1'

    def test_fixture_1_x(fixture_1):
>       assert fixture_1 == "x1"
E       AssertionError: assert 'y1' == 'x1'
E         - y1
E         + x1

ini_plugin_selection/tests/test_module.py:9: AssertionError
________________________________________________ test_fixture_2_x _________________________________________________

fixture_2 = 'y2'

    def test_fixture_2_x(fixture_2):
>       assert fixture_2 == "x2"
E       AssertionError: assert 'y2' == 'x2'
E         - y2
E         + x2

ini_plugin_selection/tests/test_module.py:12: AssertionError
======================================= 2 failed, 4 passed in 0.09 seconds ========================================
</pre>
</details>
<br>

**Config XY**
<details>
<summary>Click to expand!</summary>
<pre>
$ python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_xy.ini
================================================= test session starts ==================================================
platform darwin -- Python 3.7.3, pytest-5.0.1, py-1.8.0, pluggy-0.12.0 -- /Users/USERX/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/USERX/pytest_behavior/ini_plugin_selection, inifile: ini_plugin_selection/config/config_xy.ini
plugins: openfiles-0.3.2, arraydiff-0.3, doctestplus-0.3.0, cases-2.2.5, remotedata-0.3.1
collected 6 items

ini_plugin_selection/tests/test_module.py::test_control PASSED                                                   [ 16%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_x FAILED                                               [ 33%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_x FAILED                                               [ 50%]
ini_plugin_selection/tests/test_module.py::test_fixture_1_y PASSED                                               [ 66%]
ini_plugin_selection/tests/test_module.py::test_fixture_2_y PASSED                                               [ 83%]
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED                                               [100%]

======================================================= FAILURES =======================================================
___________________________________________________ test_fixture_1_x ___________________________________________________

fixture_1 = 'y1'

    def test_fixture_1_x(fixture_1):
>       assert fixture_1 == "x1"
E       AssertionError: assert 'y1' == 'x1'
E         - y1
E         + x1

ini_plugin_selection/tests/test_module.py:9: AssertionError
___________________________________________________ test_fixture_2_x ___________________________________________________

fixture_2 = 'y2'

    def test_fixture_2_x(fixture_2):
>       assert fixture_2 == "x2"
E       AssertionError: assert 'y2' == 'x2'
E         - y2
E         + x2

ini_plugin_selection/tests/test_module.py:12: AssertionError
========================================== 2 failed, 4 passed in 0.07 seconds ==========================================
</pre>
</details>
<br>

**Two Configs**
<details>
<summary>Click to expand!</summary>
<pre>
$  python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_y.ini -c ini_plugin_selection/config/config_x.ini
================================================= test session starts ==================================================
platform darwin -- Python 3.7.3, pytest-5.0.1, py-1.8.0, pluggy-0.12.0 -- /Users/USERX/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/USERX/pytest_behavior/ini_plugin_selection, inifile: ini_plugin_selection/config/config_x.ini
...
$
$
$  python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_x.ini -c ini_plugin_selection/config/config_y.ini
================================================= test session starts ==================================================
platform darwin -- Python 3.7.3, pytest-5.0.1, py-1.8.0, pluggy-0.12.0 -- /Users/USERX/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /Users/USERX/pytest_behavior/ini_plugin_selection, inifile: ini_plugin_selection/config/config_y.ini
...
</pre>
</details>
<br>


# Observations

## **Config X**

Is this session the x tests pass as expected and the y tests fail. We also see that we can reference
multiple plugin simultaneously as seen by the abc test case which also passes.
```
ini_plugin_selection/tests/test_module.py::test_control PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_1_x PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_2_x PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_1_y FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_2_y FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED
```


## **Config Y**

Is this session the y tests pass as expected and the x tests fail.

```
ini_plugin_selection/tests/test_module.py::test_control PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_1_x FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_2_x FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_1_y PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_2_y PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED
```

## **Config XY**

In this session we see that since the y plugin was specified after the x plugin it takes precedence
for the common fixtures between those plugins. This matches the same overriding behavior seen
with the order of the `pytest_plugins` global.
```
ini_plugin_selection/tests/test_module.py::test_control PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_1_x FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_2_x FAILED
ini_plugin_selection/tests/test_module.py::test_fixture_1_y PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_2_y PASSED
ini_plugin_selection/tests/test_module.py::test_fixture_abc PASSED
```

## **Two Configs**

What we find here is that pytest will accept multiple config files but will only retain the last
one specified.
```shell
# Y then X, X is selected
$  python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_y.ini -c ini_plugin_selection/config/config_x.ini
inifile: ini_plugin_selection/config/config_x.ini

# X then Y, Y is selected
$  python -m pytest ini_plugin_selection -c ini_plugin_selection/config/config_x.ini -c ini_plugin_selection/config/config_y.ini
inifile: ini_plugin_selection/config/config_y.ini
```


<br><br>

# Summary
In a nutshell sets of plugins can be specified from ini files, where each file references different
fixture definitions. This is another technique to exercise upon a common set of test modules with
different fixture implementations. Also the order of the plugins at the command line follow the same
precedence rules that a hardcoded `pytest_plugins` global adopts, which is to say that that the
latter plugins hold precedence over earlier plugins in the list.
